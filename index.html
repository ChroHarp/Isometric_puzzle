<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>三視圖推理遊戲（九宮格立方體）</title>
<style>
  :root { --bg:#f9fafb; --panel:#ffffff; --text:#0f172a; --accent:#2563eb; --good:#16a34a; }
  *{box-sizing:border-box;}
  body { margin:0; background:var(--bg); color:var(--text); font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; min-height:100vh; display:flex; flex-direction:column; align-items:center; }
  header { width:100%; display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:var(--panel); box-shadow:0 2px 5px rgba(0,0,0,.08); position:sticky; top:0; z-index:10; }
  header h1 { margin:0; font-size:1.2rem; font-weight:800; }
  .top-controls { display:flex; gap:10px; align-items:center; }
  select { font-size:1rem; }
  button { background:#2563eb; color:#fff; border:none; border-radius:10px; padding:10px 18px; font-weight:800; cursor:pointer; }
  #scoreText, #timerText { font-size:1.2rem; font-weight:800; color:var(--accent); }
  #modeChange{background-color: darkgreen}
  /* 桌機：原本雙欄布局 */
  main { flex:1; display:grid; grid-template-columns:280px 640px; grid-template-rows:auto auto; gap:0; align-items:start; justify-content:center; padding:10px 0 16px; }

  .input-area { display:flex; flex-direction:column; align-items:center; gap:8px; }
  .inputGrid { display:grid; grid-template-columns:repeat(3,60px); gap:4px; z-index:2; }
  .inputCell { width:60px; height:60px; background:#e2e8f0; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:800; cursor:pointer; user-select:none; }
  .hint-btn { margin-top:8px; padding:8px 14px; border-radius:10px; background:#e2e8f0; border:1px solid #94a3b8; cursor:pointer; }
  .hint-btn:disabled{ opacity:.5; cursor:not-allowed; }
  .dot { width:10px; height:10px; color:#A0A;font-weight: 900; border-radius:50%; }

  .stage { position:relative; width:640px; height:460px; display:flex; justify-content:center; align-items:center; }
  canvas { background:#f1f5f9; border:1px solid #cbd5e1; border-radius:12px; width:600px; height:440px; }
  .stage .dot { position:absolute; left:42%; bottom:12%; }

  .bottom { grid-column:1 / span 2; display:flex; align-items:flex-start; justify-content:center; gap:24px; margin-top:-20px; }
  .ctrl { display:flex; flex-direction:column; gap:8px; align-items:flex-start; }
  .ctrl button { background:#2563eb; color:#fff; border:none; border-radius:10px; padding:10px 18px; font-weight:800; cursor:pointer; }
  .ctrl strong { font-size:1.2rem; color:var(--accent); }
  #message{ min-height:24px; font-weight:700; }

  .views { display:flex; gap:14px; width:600px; justify-content:space-between; }
  .viewBox { display:flex; flex-direction:column; align-items:center; gap:6px; }
  .viewBox>div:first-child{ font-weight:800; }
  .grid3 { display:grid; grid-template-columns:repeat(3,40px); grid-template-rows:repeat(3,40px); gap:2px; }
  .cell { background:#fff; border:1px solid #cbd5e1; width:40px; height:40px; border-radius:6px; }
  .topFill { background:#ef4444; }
  .frontFill { background:#3b82f6; }
  .rightFill { background:#facc15; }

  /* 覆蓋層：最高層 + 攔截事件 + 轉場 */
  #finalScore {
    position:fixed; inset:0; background:rgba(255,255,255,0.96);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    z-index:10000;               /* 關鍵：確保最上層 */
    pointer-events:none;         /* 預設不攔截（隱形狀態） */
    opacity:0; transition:opacity .18s ease;
  }
  #finalScore.visible { opacity:1; pointer-events:auto; }
  #scoreDisplay { font-size:3rem; font-weight:900; color:var(--accent); margin-bottom:12px; }

  /* 顯示覆蓋層時，整頁停用互動（避免穿透點擊） */
  body.modal-open header,
  body.modal-open main { pointer-events:none; }
  /* 也可加點霧化效果（可選）： */
  /* body.modal-open main { filter: blur(2px); } */

  /* ========= 手機斷點：Stage → 2×2 田字格（左上/右上/左下=三視圖；右下=輸入區），隱藏 ctrl ========= */
  @media (max-width: 768px) {
    header { flex-direction:column; gap:6px; text-align:center; }

    main {
      width:100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "stage stage"
        "lt    rt"
        "lb    rb";
      gap:12px;
      padding:10px;
      align-items:start;
      justify-items:center;
    }

    .bottom { display: contents; }

    .stage { grid-area: stage; width:100%; height:auto; }
    canvas { width:92vw; height:auto; }

    .views { display: contents; }
    #topBox   { grid-area: lt; }
    #frontBox { grid-area: lb; }
    #rightBox { grid-area: rt; }

    .input-area { grid-area: rb; }

    .ctrl { display:none; }

    .inputGrid { grid-template-columns:repeat(3,48px); }
    .inputCell { width:48px; height:48px; font-size:20px; }
    .grid3 { grid-template-columns:repeat(3,28px); grid-template-rows:repeat(3,28px); }
    .cell { width:28px; height:28px; }
    #scoreText, #timerText { font-size:1.1rem; }
  }
</style>
</head>
<body>
<header>
  <h1>三視圖推理遊戲 · 九宮格立方體</h1>
  <button id="modeChange" onclick="location.href='vsmode.html'">雙人對戰</button>
  <div class="top-controls">
    <label for="difficulty">難度：</label>
    <select id="difficulty">
      <option value="baby">幼幼</option>
      <option value="easy">簡單</option>
      <option value="normal" selected>普通</option>
      <option value="hard">困難</option>
      <option value="hell">地獄</option>
    </select>
    <button id="startBtn">開始</button>
    <span id="timerText">剩餘時間：02:00</span>
    <span id="scoreText">得分：0</span>
  </div>
</header>

<main>
  <section class="input-area">
    <h3>輸入區</h3>
    <div id="inputGrid" class="inputGrid"></div>
    <div class="dot">&uarr;</div>
    <button id="hintBtn" class="hint-btn" disabled>提示</button>
  </section>

  <section class="stage">
    <canvas id="iso" width="600" height="440"></canvas>
    <div class="dot">&nearr;</div>
  </section>

  <section class="bottom">
    <div class="ctrl">
      <button id="startBtn2">開始</button>
      <strong id="timerText2">剩餘時間：02:00</strong>
      <strong id="scoreText2">得分：0</strong>
      <div id="message"></div>
    </div>

    <div class="views">
      <div id="topBox" class="viewBox"><div>上視圖</div><div id="topView" class="grid3"></div></div>
      <div id="frontBox" class="viewBox"><div>前視圖</div><div id="frontView" class="grid3"></div></div>
      <div id="rightBox" class="viewBox"><div>右視圖</div><div id="rightView" class="grid3"></div></div>
    </div>
  </section>
</main>

<div id="finalScore">
  <div id="scoreDisplay"></div>
  <small>點擊任意處關閉</small>
</div>

<script>
(function(){
'use strict';

/* ========= 基本工具 ========= */
const clamp=(n,min,max)=>Math.min(max,Math.max(min,n));
const zeros3=()=>Array.from({length:3},()=>Array(3).fill(0));
const isNum=v=>typeof v==='number' && isFinite(v);
const safe=v=>isNum(v)?v:0;
function norm3x3(m){ const o=[[0,0,0],[0,0,0],[0,0,0]]; if(!Array.isArray(m)) return o; for(let r=0;r<3;r++){ const row=Array.isArray(m[r])?m[r]:[0,0,0]; o[r][0]=safe(row[0]); o[r][1]=safe(row[1]); o[r][2]=safe(row[2]); } return o; }
function writeCell(m,r,c,val){ const g=norm3x3(m); g[clamp(r,0,2)][clamp(c,0,2)]=safe(val); return g; }
function shuffle(a){ const x=a.slice(); for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]]; } return x; }

/* ========= 題庫 ========= */
const easyFixed = shuffle([
  [[0,1,0],[0,2,0],[0,0,0]], [[1,0,1],[0,2,0],[0,0,0]], [[0,1,0],[1,2,0],[0,0,0]], [[0,1,0],[1,1,2],[0,0,0]],
  [[1,0,0],[0,2,0],[0,0,1]], [[0,1,0],[0,2,1],[0,0,0]], [[1,2,0],[0,1,0],[0,0,0]], [[0,0,1],[1,2,0],[0,0,0]],
  [[0,1,0],[0,2,0],[0,1,0]], [[1,0,2],[0,0,0],[1,0,0]]
]);

const mediumFixed = shuffle([
  [[2,1,0],[3,2,1],[1,1,0]], [[1,2,3],[2,1,1],[0,1,0]], [[1,1,2],[2,3,1],[0,0,1]], [[1,1,1],[3,2,1],[0,0,0]], [[2,1,2],[1,3,1],[0,0,1]],
  [[3,1,1],[2,2,0],[1,1,0]], [[1,3,0],[2,2,1],[0,0,1]], [[2,1,1],[1,3,1],[0,1,0]], [[1,2,3],[1,1,1],[0,0,1]], [[2,2,1],[1,3,0],[0,1,1]],
  [[1,1,2],[3,1,1],[0,1,0]], [[1,2,1],[2,3,0],[1,0,0]], [[3,1,1],[1,2,1],[0,0,1]], [[2,1,2],[1,3,1],[0,0,0]], [[1,3,0],[2,2,1],[0,1,0]]
].filter(p => p.flat().reduce((a,b)=>a+b,0) > 8 && p.flat().some(x=>x>=3)));

const rot90=m=>m[0].map((_,c)=>m.map(r=>r[c]).reverse());
const mirH=m=>m.map(r=>r.slice().reverse());
const allKeys=m=>{ const arr=[]; let t=m; for(let i=0;i<4;i++){ arr.push(t); arr.push(mirH(t)); t=rot90(t); } return arr.map(x=>x.flat().join(',')); };
const keyOf=m=>allKeys(m).sort()[0];
function genHardBank(want=160){
  const seen=new Set(), out=[];
  let guard=0;
  while(out.length<want && guard<20000){
    guard++;
    const vals=Array(9).fill(0);
    const nz=4+Math.floor(Math.random()*3);
    const idxs=shuffle([...Array(9).keys()]).slice(0,nz);
    for(const i of idxs){ vals[i] = Math.max(1, Math.min(9, Math.round(2 + Math.random()*5))); }
    const m=[vals.slice(0,3),vals.slice(3,6),vals.slice(6,9)];
    const flat=m.flat(); const sum=flat.reduce((a,b)=>a+b,0); const tall=flat.filter(x=>x>=3).length;
    if(sum<13 || sum>17) continue;
    if(tall<2) continue;
    const k=keyOf(m); if(seen.has(k)) continue;
    seen.add(k); out.push(m);
  }
  return out.length?out:[[[3,2,3],[2,3,2],[1,1,1]]];
}
const hardBank = genHardBank();

/* ========= 題組規格與池 ========= */
const spec = {
  baby:   { rounds:5, types: ['easy','easy','easy','easy','easy'] },
  easy:   { rounds:8, types: ['easy','easy','easy','easy','medium','medium','medium','medium'] },
  normal: { rounds:8, types: ['easy','easy','medium','medium','medium','hard','hard','hard'] },
  hard:   { rounds:8, types: ['medium','medium','medium','medium','hard','hard','hard','hard'] },
  hell:   { rounds:8, types: ['hard','hard','hard','hard','hard','hard','hard','hard'] }
};

function buildOneBundle(typeSeq){
  if(!buildOneBundle.ptr) buildOneBundle.ptr={easy:0,medium:0,hard:0};
  const res=[];
  for(const t of typeSeq){
    if(t==='easy'){ const i=buildOneBundle.ptr.easy++ % easyFixed.length;   res.push(easyFixed[i]); }
    else if(t==='medium'){ const i=buildOneBundle.ptr.medium++ % mediumFixed.length; res.push(mediumFixed[i]); }
    else { const i=buildOneBundle.ptr.hard++ % hardBank.length; res.push(hardBank[i]); }
  }
  return res.map(norm3x3);
}
function buildBundles(){
  const bundles={ baby:[], easy:[], normal:[], hard:[], hell:[] };
  for(let i=0;i<3;i++) bundles.baby.push(buildOneBundle(spec.baby.types));
  for(let i=0;i<5;i++) bundles.easy.push(buildOneBundle(spec.easy.types));
  for(let i=0;i<5;i++) bundles.normal.push(buildOneBundle(spec.normal.types));
  for(let i=0;i<5;i++) bundles.hard.push(buildOneBundle(spec.hard.types));
  for(let i=0;i<3;i++) bundles.hell.push(buildOneBundle(spec.hell.types));
  return bundles;
}
const bundlePool = buildBundles();

/* ========= 狀態 ========= */
let running=false, endAt=0, nextHintAt=0;
let total=0, round=0, hintCnt=0;
let mode='normal', currentSet=[];
let guess=zeros3(), target=zeros3();

/* ========= 等角繪製（只畫 guess） ========= */
const SIZE=3;
  
const theta = 28 * Math.PI / 180; // 控制左右傾斜角
const phi = 35 * Math.PI / 180;   // 控制俯視角
const tileW = 100;
const tileH = tileW * Math.sin(phi);
const cubeH = tileW * Math.cos(phi) * 0.55;
    
const cvs=document.getElementById('iso'); const ctx=cvs.getContext('2d');
let originX=cvs.width/2+40, originY=cvs.height/2+60;
const tiles=[]; const rh=(cx,cy,w,h)=>{ const p=new Path2D(); p.moveTo(cx,cy-h/2); p.lineTo(cx+w/2,cy); p.lineTo(cx,cy+h/2); p.lineTo(cx-w/2,cy); p.closePath(); return p; };
const ori=(c,r)=>({ x:originX+(c-r)*(tileW/2), y:originY+(c+r)*(tileH/2) });
for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++){ const o=ori(c,r); tiles.push({r,c,cx:o.x,cy:o.y,path:rh(o.x,o.y,tileW,tileH)}); }
function drawCube(cx,cy,l){ const z=cy-l*cubeH;
  ctx.beginPath(); ctx.moveTo(cx,z-tileH/2); ctx.lineTo(cx+tileW/2,z); ctx.lineTo(cx,z+tileH/2); ctx.lineTo(cx-tileW/2,z); ctx.closePath(); ctx.fillStyle='#ef4444'; ctx.fill(); ctx.strokeStyle='#94a3b8'; ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx+tileW/2,z); ctx.lineTo(cx+tileW/2,z+cubeH); ctx.lineTo(cx,z+tileH/2+cubeH); ctx.lineTo(cx,z+tileH/2); ctx.closePath(); ctx.fillStyle='#facc15'; ctx.fill();
  ctx.beginPath(); ctx.moveTo(cx-tileW/2,z); ctx.lineTo(cx-tileW/2,z+cubeH); ctx.lineTo(cx,z+tileH/2+cubeH); ctx.lineTo(cx,z+tileH/2); ctx.closePath(); ctx.fillStyle='#3b82f6'; ctx.fill();
}
function drawGround(){ ctx.strokeStyle='#cbd5e1'; for(const t of tiles) ctx.stroke(t.path); }
function render(){
  ctx.clearRect(0,0,cvs.width,cvs.height); drawGround();
  const g=norm3x3(guess); const order=[]; for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) order.push([r,c]); order.sort((a,b)=>(a[0]+a[1])-(b[0]+b[1]));
  for(const [r,c] of order){
    const t=tiles.find(x=>x.r===r&&x.c===c);
    const h = Math.min( safe(g[r][c]), 3 );
    for(let k=1;k<=h;k++) drawCube(t.cx,t.cy,k);
  }
}

/* ========= 三視圖 ========= */
const topV=document.getElementById('topView'), frontV=document.getElementById('frontView'), rightV=document.getElementById('rightView');
function initView(v){ v.innerHTML=''; for(let i=0;i<9;i++){ const d=document.createElement('div'); d.className='cell'; v.appendChild(d);} }
[topV,frontV,rightV].forEach(initView);
function viewsOf(a){ a=norm3x3(a);
  const top=a.map(row=>row.map(v=>v>0?1:0));
  const front=Array.from({length:3},()=>Array(3).fill(0));
  for(let c=0;c<3;c++){ let k=0; for(let r=0;r<3;r++) k=Math.max(k,safe(a[r][c])); k=Math.min(k,3); for(let i=0;i<k;i++) front[2-i][c]=1; }
  const right=Array.from({length:3},()=>Array(3).fill(0));
  for(let r=0;r<3;r++){ let k=0; for(let c=0;c<3;c++) k=Math.max(k,safe(a[r][c])); k=Math.min(k,3); const col=2-r; for(let i=0;i<k;i++) right[2-i][col]=1; }
  return {top,front,right};
}
function paintView(el,data,type){ const cells=el.querySelectorAll('.cell'); cells.forEach((cell,i)=>{ const r=Math.floor(i/3),c=i%3; cell.classList.remove('topFill','frontFill','rightFill'); if(data[r][c]===1){ if(type==='top')cell.classList.add('topFill'); if(type==='front')cell.classList.add('frontFill'); if(type==='right')cell.classList.add('rightFill'); }}); }
function refreshViews(){ const {top,front,right}=viewsOf(target); paintView(topV,top,'top'); paintView(frontV,front,'front'); paintView(rightV,right,'right'); }

/* ========= 輸入九宮格 ========= */
const inputGrid=document.getElementById('inputGrid');
function rebuildInput(){
  inputGrid.innerHTML='';
  for(let i=0;i<9;i++){
    const r=Math.floor(i/3), c=i%3;
    const cell=document.createElement('div'); cell.className='inputCell';
    cell.textContent=String(norm3x3(guess)[r][c]);
    cell.addEventListener('click',()=>{
      const cur = norm3x3(guess)[r][c];
      guess = writeCell(guess, r, c, (safe(cur)+1)%4);
      cell.textContent = String(norm3x3(guess)[r][c]);
      render(); checkSolved();
    });
    inputGrid.appendChild(cell);
  }
}
function syncInput(){ const g=norm3x3(guess); inputGrid.querySelectorAll('.inputCell').forEach((el,i)=>{ const r=Math.floor(i/3),c=i%3; el.textContent=String(g[r][c]); }); }
rebuildInput();

/* ========= 判斷 / 提示 / 分數 ========= */
const msgEl=document.getElementById('message');
function msg(t,c){ msgEl.textContent=t; msgEl.style.color=c||'inherit'; }
function viewsMatch(){ const A=viewsOf(target), B=viewsOf(guess); const eq=(x,y)=>x.flat().every((v,i)=>v===y.flat()[i]); return eq(A.top,B.top)&&eq(A.front,B.front)&&eq(A.right,B.right); }
function flash(){ cvs.style.transform='scale(1.03)'; cvs.style.boxShadow='0 0 14px rgba(34,197,94,.9)'; setTimeout(()=>{cvs.style.transform=''; cvs.style.boxShadow='';},450); }
function hint(){
  const T=norm3x3(target), G=norm3x3(guess);
  const wrong=[]; for(let r=0;r<3;r++) for(let c=0;c<3;c++) if(G[r][c]!==T[r][c]) wrong.push([r,c]);
  if(!wrong.length) return;
  const [r,c]=wrong[Math.floor(Math.random()*wrong.length)];
  guess=writeCell(guess,r,c,T[r][c]);
  hintCnt++; render(); syncInput(); checkSolved();
}
function checkSolved(){
  if(viewsMatch()){
    const s=Math.max(10,100-20*hintCnt); total+=s;
    document.getElementById('scoreText').textContent='得分：'+total;
    document.getElementById('scoreText2').textContent='得分：'+total;
    flash(); msg('✅ 正確！自動進入下一題','var(--good)');
    setTimeout(nextQuestion,700);
    return true;
  }
  return false;
}

/* ========= 題組抽選與出題 ========= */
function chooseBundleByMode(m){
  const pool = bundlePool[m] || [];
  if(!pool.length) return [];
  const idx = Math.floor(Math.random()*pool.length);
  return pool[idx];
}
function nextQuestion(){
  round++;
  if(round>currentSet.length){
    running=false;  /* 確保停止計時循環 */
    showFinal();
    return;
  }
  target = norm3x3(currentSet[round-1]);
  guess = zeros3();
  hintCnt=0; nextHintAt=performance.now()+30000;
  document.getElementById('hintBtn').disabled=true;
  refreshViews(); render(); syncInput(); rebuildInput();
  msg(`第 ${round} 題開始！`,'var(--accent)');
}

/* ========= 計時 / 收尾 ========= */
const overlay=document.getElementById('finalScore');
let raf=null;
function showFinal(){
  /* 顯示覆蓋層：最上層並鎖住下層互動 */
  overlay.classList.add('visible');
  document.getElementById('scoreDisplay').textContent=`最終得分：${total}`;
  document.body.classList.add('modal-open');
  overlay.addEventListener('click',()=>{
    overlay.classList.remove('visible');
    document.body.classList.remove('modal-open');
    reset();
  }, {once:true});
}
function tick(){
  if(!running){ cancelAnimationFrame(raf); return; }
  const remain=Math.max(0,endAt-performance.now());
  const mm=Math.floor(remain/60000), ss=Math.floor((remain%60000)/1000);
  const t=`剩餘時間：${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  document.getElementById('timerText').textContent=t;
  document.getElementById('timerText2').textContent=t;
  if(remain<=0){ running=false; showFinal(); return; }
  if(performance.now()>=nextHintAt){ document.getElementById('hintBtn').disabled=false; nextHintAt+=30000; }
  raf=requestAnimationFrame(tick);
}

/* ========= 開始 / 重置 ========= */
function start(){
  if(running){ reset(); }
  mode=document.getElementById('difficulty').value;
  currentSet = chooseBundleByMode(mode);
  if(!currentSet.length){ msg('此難度沒有題組，請重新整理','crimson'); return; }

  total=0; round=0; hintCnt=0;
  running=true; endAt=performance.now()+120000; nextHintAt=performance.now()+30000;
  document.getElementById('hintBtn').disabled=true;
  document.getElementById('scoreText').textContent='得分：0';
  document.getElementById('scoreText2').textContent='得分：0';
  document.getElementById('timerText').textContent='剩餘時間：02:00';
  document.getElementById('timerText2').textContent='剩餘時間：02:00';
  nextQuestion(); tick();
}
function reset(){
  running=false; total=0; round=0; hintCnt=0;
  target=zeros3(); guess=zeros3();
  document.getElementById('scoreText').textContent='得分：0';
  document.getElementById('scoreText2').textContent='得分：0';
  document.getElementById('timerText').textContent='剩餘時間：02:00';
  document.getElementById('timerText2').textContent='剩餘時間：02:00';
  render(); refreshViews(); syncInput(); rebuildInput(); msg('已重置，請按開始','var(--accent)');
}

/* ========= 綁定 ========= */
document.getElementById('startBtn').addEventListener('click',start);
document.getElementById('startBtn2').addEventListener('click',start);
document.getElementById('hintBtn').addEventListener('click',hint);

/* ========= 初始渲染與基本測試 ========= */
render(); refreshViews();
(function tests(){
  const s=[[2,3,1],[0,1,1],[0,0,1]];
  const eT=[[1,1,1],[0,1,1],[0,0,1]];
  const eF=[[0,1,0],[1,1,0],[1,1,1]];
  const eR=[[0,0,1],[0,0,1],[1,1,1]];
  const v=viewsOf(s);
  console.assert(JSON.stringify(v.top)===JSON.stringify(eT),'Top fail',v.top);
  console.assert(JSON.stringify(v.front)===JSON.stringify(eF),'Front fail',v.front);
  console.assert(JSON.stringify(v.right)===JSON.stringify(eR),'Right fail',v.right);
})();
})();
</script>
</body>
</html>
